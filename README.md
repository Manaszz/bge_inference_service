# BGE Inference Service

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –∏ —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞ –Ω–∞ –±–∞–∑–µ –º–æ–¥–µ–ª–µ–π —Å–µ–º–µ–π—Å—Ç–≤–∞ **BGE (FlagEmbedding)**. 

–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –∫–∞–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è RAG-—Å–∏—Å—Ç–µ–º, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (Dense + Sparse) –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ GPU.

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π REST API –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—è–∂–µ–ª—ã—Ö –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á NLP, –∏–∑–æ–ª–∏—Ä—É—è –∏—Ö –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

### –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
- **Dense Embeddings**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–æ—Ç–Ω—ã—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ (BGE-M3) –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å OpenAI API.
- **Sparse Embeddings**: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ª–µ–∫—Å–∏—á–µ—Å–∫–∏—Ö –≤–µ—Å–æ–≤ (Lexical Weights) –∏ –∏—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã–µ –≤–µ–∫—Ç–æ—Ä—ã (Indices + Values).
- **Hybrid Embeddings**: –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–æ—Ç–Ω—ã—Ö –∏ —Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ –∑–∞ –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥ –º–æ–¥–µ–ª–∏ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è GPU-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞).
- **Cross-Encoder Rerank**: –í—ã—Å–æ–∫–æ—Ç–æ—á–Ω–æ–µ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—Ä–æ—Å–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Cross-Encoder –º–æ–¥–µ–ª–µ–π.
- **Custom Sparse Mapping**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (SHA256) –∏–ª–∏ Tokenizer IDs –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏ –≤ –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, Qdrant).

---

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ Best Practices

–°–µ—Ä–≤–∏—Å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω **Model-as-a-Service (MaaS)**, —á—Ç–æ –¥–∞–µ—Ç —Ä—è–¥ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤:

1. **–ò–∑–æ–ª—è—Ü–∏—è –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤**: –¢—è–∂–µ–ª—ã–µ –º–æ–¥–µ–ª–∏ PyTorch/CUDA —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ –∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç I/O-–≤–æ—Ä–∫–µ—Ä—ã –æ—Å–Ω–æ–≤–Ω–æ–≥–æ API.
2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**: –û–±—Ä–∞–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –ª–µ–≥–∫–∏–º (~200MB), –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ GPU-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (5GB+) –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –¥–∞–Ω–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ.
3. **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–ø–ª–∏–∫ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å-—Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö GPU-–Ω–æ–¥–∞—Ö –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –±—ç–∫–µ–Ω–¥–∞.
4. **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –í —Å–µ—Ä–≤–∏—Å –∑–∞–ª–æ–∂–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤, –∏–¥–µ–Ω—Ç–∏—á–Ω–∞—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É RAG-–ø—Ä–æ–µ–∫—Ç—É, —á—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–æ–≤ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏.

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Docker Compose)

–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å –Ω–∞ GPU:

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫
git clone https://github.com/Manaszz/bge_inference_service.git
cd bge_inference_service
docker compose up --build -d
```

–°–µ—Ä–≤–∏—Å —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:8011`
Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `http://localhost:8011/docs`

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|-----------------------|----------|
| `DEVICE` | `cuda` | –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ (`cuda` –∏–ª–∏ `cpu`). |
| `EMBEDDING_MODEL_NAME` | `BAAI/bge-m3` | –ú–æ–¥–µ–ª—å –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤. |
| `RERANKER_MODEL_NAME` | `BAAI/bge-reranker-v2-m3` | –ú–æ–¥–µ–ª—å –¥–ª—è —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞. |
| `EMBEDDING_SIZE` | `1024` | –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å dense-–≤–µ–∫—Ç–æ—Ä–∞ (–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ). |
| `SPARSE_TOKEN_MAPPING` | `tokenizer` | –ú–µ—Ç–æ–¥ –º–∞–ø–ø–∏–Ω–≥–∞: `tokenizer` (ID —Ç–æ–∫–µ–Ω–æ–≤) –∏–ª–∏ `hash` (SHA256). |
| `SPARSE_INDEX_SPACE` | `1048576` | –†–∞–∑–º–µ—Ä –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è sparse-–≤–µ–∫—Ç–æ—Ä–∞ (2^20). |
| `USE_FP16` | `true` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–ª–æ–≤–∏–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è GPU). |

---

## üõ† API Documentation

### 1. –ü–ª–æ—Ç–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ (OpenAI Compatible)
`POST /v1/embeddings`

**Request:**
```json
{
  "model": "bge-m3",
  "input": ["–¢–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"],
  "encoding_format": "float"
}
```

**Response:**
```json
{
  "object": "list",
  "model": "bge-m3",
  "data": [
    {
      "object": "embedding",
      "index": 0,
      "embedding": [0.012, -0.045, ...] // 1024 –∏–∑–º–µ—Ä–µ–Ω–∏—è
    }
  ],
  "usage": {"prompt_tokens": 0, "total_tokens": 0}
}
```

### 2. –†–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏
`POST /v1/sparse-embeddings`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ—Å–∞ —Ç–æ–∫–µ–Ω–æ–≤, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ –∏–Ω–¥–µ–∫—Å—ã.

**Request:**
```json
{ "input": "–ö–∞–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±–ª–∏–≥–∞—Ü–∏–∏?" }
```

**Response:**
```json
{
  "model": "BAAI/bge-m3",
  "data": [
    {
      "index": 0,
      "sparse": {
        "indices": [1284, 4592, 901],
        "values": [0.45, 0.21, 0.11],
        "mapping": "tokenizer",
        "index_space": 1048576
      }
    }
  ]
}
```

### 3. –ì–∏–±—Ä–∏–¥–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ (–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
`POST /v1/hybrid-embeddings`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏ dense, –∏ sparse –≤–µ–∫—Ç–æ—Ä—ã –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≤ Qdrant.

### 4. –†–µ—Ä–∞–Ω–∫–∏–Ω–≥ (Cohere Style)
`POST /v1/rerank`

–í—ã—á–∏—Å–ª—è–µ—Ç –æ—Ü–µ–Ω–∫—É —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–∞—Ä –∑–∞–ø—Ä–æ—Å-–¥–æ–∫—É–º–µ–Ω—Ç.

**Request:**
```json
{
  "query": "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–ø—É—Å–∫–∞",
  "documents": [
    "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥...",
    "–ö—É–ª–∏–Ω–∞—Ä–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –ø–∏—Ü—Ü—ã"
  ],
  "top_n": 1
}
```

**Response:**
```json
{
  "model": "BAAI/bge-reranker-v2-m3",
  "results": [
    {
      "index": 0,
      "relevance_score": 8.42,
      "document": null
    }
  ]
}
```

---

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RAG –ø–∞–π–ø–ª–∞–π–Ω–æ–º

### –°—Ü–µ–Ω–∞—Ä–∏–π: Hybrid Retrieval + Rerank

```python
import requests

# 1. –ü–æ–ª—É—á–∞–µ–º –≥–∏–±—Ä–∏–¥–Ω—ã–π –≤–µ–∫—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞
hybrid_data = requests.post("http://localhost:8011/v1/hybrid-embeddings", 
                            json={"input": "–ú–æ–π –≤–æ–ø—Ä–æ—Å"}).json()["data"][0]

# 2. –ü–æ–∏—Å–∫ –≤ Qdrant (–∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ dense –∏ sparse –≤–µ–∫—Ç–æ—Ä—ã)
search_results = qdrant_client.query_points(
    collection_name="docs",
    prefetch=[
        {"query": hybrid_data["dense"], "using": "dense", "limit": 20},
        {"query": hybrid_data["sparse"], "using": "sparse", "limit": 20}
    ],
    limit=20
)

# 3. –†–µ—Ä–∞–Ω–∫–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
rerank_req = {
    "query": "–ú–æ–π –≤–æ–ø—Ä–æ—Å",
    "documents": [hit.payload["text"] for hit in search_results.points],
    "top_n": 5
}
top_hits = requests.post("http://localhost:8011/v1/rerank", json=rerank_req).json()["results"]

# 4. –ü–µ—Ä–µ–¥–∞—á–∞ top_hits –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç LLM
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —é–∑–∫–µ–π—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç:

```bash
# –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π requests –∏ pytest
python bge_inference_service/test_integration.py
```

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è
–î–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é —Å–∏—Å—Ç–µ–º—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è "–∫–∞–∫ –µ—Å—Ç—å". –ú–æ–¥–µ–ª–∏ BGE –∏ Reranker –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç BAAI –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ–¥ –∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏.
