# BGE Inference Service

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –∏ —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞ –Ω–∞ –±–∞–∑–µ –º–æ–¥–µ–ª–µ–π —Å–µ–º–µ–π—Å—Ç–≤–∞ **BGE (FlagEmbedding)**. 

–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –∫–∞–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è RAG-—Å–∏—Å—Ç–µ–º, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (Dense + Sparse) –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ GPU.

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π REST API –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—è–∂–µ–ª—ã—Ö –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á NLP, –∏–∑–æ–ª–∏—Ä—É—è –∏—Ö –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

### –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
- **Dense Embeddings**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–æ—Ç–Ω—ã—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ (BGE-M3) –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å OpenAI API.
- **Sparse Embeddings**: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ª–µ–∫—Å–∏—á–µ—Å–∫–∏—Ö –≤–µ—Å–æ–≤ (Lexical Weights) –∏ –∏—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã–µ –≤–µ–∫—Ç–æ—Ä—ã (Indices + Values).
- **Hybrid Embeddings**: –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–æ—Ç–Ω—ã—Ö –∏ —Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ –∑–∞ –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥ –º–æ–¥–µ–ª–∏ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è GPU-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞).
- **Cross-Encoder Rerank**: –í—ã—Å–æ–∫–æ—Ç–æ—á–Ω–æ–µ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—Ä–æ—Å–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Cross-Encoder –º–æ–¥–µ–ª–µ–π.
- **Custom Sparse Mapping**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (SHA256) –∏–ª–∏ Tokenizer IDs –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏ –≤ –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, Qdrant).

---

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ Best Practices

–°–µ—Ä–≤–∏—Å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω **Model-as-a-Service (MaaS)**, —á—Ç–æ –¥–∞–µ—Ç —Ä—è–¥ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤:

1. **–ò–∑–æ–ª—è—Ü–∏—è –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤**: –¢—è–∂–µ–ª—ã–µ –º–æ–¥–µ–ª–∏ PyTorch/CUDA —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ –∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç I/O-–≤–æ—Ä–∫–µ—Ä—ã –æ—Å–Ω–æ–≤–Ω–æ–≥–æ API.
2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**: –û–±—Ä–∞–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –ª–µ–≥–∫–∏–º (~200MB), –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ GPU-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (5GB+) –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –¥–∞–Ω–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ.
3. **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–ø–ª–∏–∫ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å-—Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö GPU-–Ω–æ–¥–∞—Ö –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –±—ç–∫–µ–Ω–¥–∞.
4. **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –í —Å–µ—Ä–≤–∏—Å –∑–∞–ª–æ–∂–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤, –∏–¥–µ–Ω—Ç–∏—á–Ω–∞—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É RAG-–ø—Ä–æ–µ–∫—Ç—É, —á—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–æ–≤ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏.

---

## üßµ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –æ—á–µ—Ä–µ–¥—å –∏ –º–∏–∫—Ä–æ–±–∞—Ç—á–∏–Ω–≥

### –ß—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å
- **HTTP-–ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º**: FastAPI/uvicorn –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
- **GPU-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å**: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∏–Ω—Ñ–µ—Ä–µ–Ω—Å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–∞—Ö —á–∞—Å—Ç–æ –Ω–µ —É—Å–∫–æ—Ä—è–µ—Ç, –∞ —É—Ö—É–¥—à–∞–µ—Ç latency/throughput. –õ—É—á—à–∏–π –ø–æ–¥—Ö–æ–¥ ‚Äî **–æ—á–µ—Ä–µ–¥—å + –º–∏–∫—Ä–æ–±–∞—Ç—á–∏–Ω–≥**.
- **BGE encode –±–∞—Ç—á–∏—Ç—Å—è**: `BGEM3FlagModel.encode()` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç **—Å–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç–æ–≤** –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä `batch_size` ‚Äî —Ç–æ –µ—Å—Ç—å –º–æ–¥–µ–ª—å —É–º–µ–µ—Ç —Å—á–∏—Ç–∞—Ç—å –ø–∞—á–∫—É –∑–∞ –≤—ã–∑–æ–≤.

### –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–∏–∫—Ä–æ–±–∞—Ç—á–µ—Ä (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ–∫ —Å –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤ RAG)
–°–µ—Ä–≤–∏—Å –º–æ–∂–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –≤ **–∫–æ—Ä–æ—Ç–∫–æ–µ –æ–∫–Ω–æ** (–Ω–∞–ø—Ä–∏–º–µ—Ä 10–º—Å), –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —Ç–µ–∫—Å—Ç—ã –≤ –æ–±—â–∏–π –±–∞—Ç—á –∏ –¥–µ–ª–∞—Ç—å –º–µ–Ω—å—à–µ –≤—ã–∑–æ–≤–æ–≤ `encode()`:

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
- `EMBEDDING_MICROBATCH_ENABLED`: –≤–∫–ª—é—á–∏—Ç—å –æ—á–µ—Ä–µ–¥—å+–º–∏–∫—Ä–æ–±–∞—Ç—á–∏–Ω–≥ (`true/false`)
- `EMBEDDING_MICROBATCH_MAX_WAIT_MS`: –æ–∫–Ω–æ —Å–±–æ—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–±—ã—á–Ω–æ 5‚Äì20–º—Å)
- `EMBEDDING_MICROBATCH_MAX_BATCH_TEXTS`: –º–∞–∫—Å–∏–º—É–º —Ç–µ–∫—Å—Ç–æ–≤ –≤ –æ–¥–Ω–æ–º –º–∏–∫—Ä–æ–±–∞—Ç—á–µ
- `EMBEDDING_MICROBATCH_QUEUE_MAXSIZE`: —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ (backpressure –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–µ)

---

## üñ•Ô∏è Multi-GPU (2‚Äì3 GPU): —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ö–µ–º–∞

### –í–∞—Ä–∏–∞–Ω—Ç A (—Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π): 1 —Ä–µ–ø–ª–∏–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ = 1 GPU
–ó–∞–ø—É—Å–∫–∞–π—Ç–µ 2‚Äì3 —Ä–µ–ø–ª–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–∞, –∫–∞–∂–¥–∞—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ –∑–∞ —Å–≤–æ–µ–π GPU (`CUDA_VISIBLE_DEVICES=0/1/2`), –∞ —Å–≤–µ—Ä—Ö—É ‚Äî –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ (nginx/traefik/k8s service).

–ü–ª—é—Å—ã:
- –Ω–µ—Ç –±–æ—Ä—å–±—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∑–∞ –æ–¥–Ω—É GPU –∏ VRAM
- –ø—Ä–æ—â–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å latency
- –ø—Ä–æ—â–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å

### –í–∞—Ä–∏–∞–Ω—Ç B: –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å, –Ω–µ—Å–∫–æ–ª—å–∫–æ GPU
–î–ª—è **rerank** –≤ `FlagReranker` —É–∂–µ –µ—Å—Ç—å multi-GPU –ø—É—Ç—å (`parallel_compute_score`).  
–î–ª—è **—ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤** –æ–±—ã—á–Ω–æ –ø—Ä–æ—â–µ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –í–∞—Ä–∏–∞–Ω—Ç A (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–ø–ª–∏–∫), —á–µ–º –¥–µ—Ä–∂–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–ø–∏–π embedder-–º–æ–¥–µ–ª–∏ –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ.

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Docker Compose)

–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å –Ω–∞ GPU:

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫
git clone https://github.com/Manaszz/bge_inference_service.git
cd bge_inference_service
docker compose up --build -d
```

–°–µ—Ä–≤–∏—Å —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:8011`
Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `http://localhost:8011/docs`

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|-----------------------|----------|
| `DEVICE` | `cuda` | –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ (`cuda` –∏–ª–∏ `cpu`). |
| `EMBEDDING_MODEL_NAME` | `BAAI/bge-m3` | –ú–æ–¥–µ–ª—å –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤. |
| `RERANKER_MODEL_NAME` | `BAAI/bge-reranker-v2-m3` | –ú–æ–¥–µ–ª—å –¥–ª—è —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞. |
| `EMBEDDING_SIZE` | `1024` | –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å dense-–≤–µ–∫—Ç–æ—Ä–∞ (–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ). |
| `SPARSE_TOKEN_MAPPING` | `tokenizer` | –ú–µ—Ç–æ–¥ –º–∞–ø–ø–∏–Ω–≥–∞: `tokenizer` (ID —Ç–æ–∫–µ–Ω–æ–≤) –∏–ª–∏ `hash` (SHA256). |
| `SPARSE_INDEX_SPACE` | `1048576` | –†–∞–∑–º–µ—Ä –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è sparse-–≤–µ–∫—Ç–æ—Ä–∞ (2^20). |
| `USE_FP16` | `true` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–ª–æ–≤–∏–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è GPU). |

---

## üõ† API Documentation

### 1. –ü–ª–æ—Ç–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ (OpenAI Compatible)
`POST /v1/embeddings`

**Request:**
```json
{
  "model": "bge-m3",
  "input": ["–¢–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"],
  "encoding_format": "float"
}
```

**Response:**
```json
{
  "object": "list",
  "model": "bge-m3",
  "data": [
    {
      "object": "embedding",
      "index": 0,
      "embedding": [0.012, -0.045, ...] // 1024 –∏–∑–º–µ—Ä–µ–Ω–∏—è
    }
  ],
  "usage": {"prompt_tokens": 0, "total_tokens": 0}
}
```

### üß∑ –ö–∞–∫ —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤—Ö–æ–¥–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ (–≤–∞–∂–Ω–æ –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö/Qdrant)

–í–æ –≤—Å–µ—Ö embeddings-—ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö –ø–æ–ª–µ `input` –º–æ–∂–µ—Ç –±—ã—Ç—å **—Å—Ç—Ä–æ–∫–æ–π** –∏–ª–∏ **—Å–ø–∏—Å–∫–æ–º —Å—Ç—Ä–æ–∫**.  
–í –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–∏—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã **–≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ**, –∞ —Ç–∞–∫–∂–µ –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç `index` ‚Äî —ç—Ç–æ **–ø–æ–∑–∏—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –≤–æ –≤—Ö–æ–¥–Ω–æ–º —Å–ø–∏—Å–∫–µ**.

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:

- **–æ–¥–∏–Ω —Ç–µ–∫—Å—Ç** ‚Üí `index = 0`
- **—Å–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç–æ–≤** ‚Üí `index = 0..N-1`, –∏ –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ –∏–Ω–¥–µ–∫—Å—É/–ø–æ—Ä—è–¥–∫—É

–ü—Ä–∏–º–µ—Ä (Qdrant ingest: dense):

```python
import requests

BGE = "http://localhost:8011"

texts = ["t1", "t2", "t3"]
ids = ["doc-1", "doc-2", "doc-3"]
metas = [{"source": "a"}, {"source": "b"}, {"source": "c"}]

resp = requests.post(f"{BGE}/v1/embeddings", json={"input": texts}).json()

# –í–∞—Ä–∏–∞–Ω—Ç A: —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ –ø–æ—Ä—è–¥–∫—É (–æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
for doc_id, text, meta, item in zip(ids, texts, metas, resp["data"]):
    vector = item["embedding"]
    payload = {**meta, "text": text}
    # qdrant_client.upsert(... id=doc_id, vector=vector, payload=payload)

# –í–∞—Ä–∏–∞–Ω—Ç B: —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ index (–µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –±—ã—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏ –æ—Ç –ø–æ—Ä—è–¥–∫–∞)
for item in resp["data"]:
    i = item["index"]
    doc_id, text, meta = ids[i], texts[i], metas[i]
    vector = item["embedding"]
    payload = {**meta, "text": text}
    # qdrant_client.upsert(... id=doc_id, vector=vector, payload=payload)
```

### 2. –†–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏
`POST /v1/sparse-embeddings`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ—Å–∞ —Ç–æ–∫–µ–Ω–æ–≤, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ –∏–Ω–¥–µ–∫—Å—ã.

**Request:**
```json
{ "input": "–ö–∞–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±–ª–∏–≥–∞—Ü–∏–∏?" }
```

**Response:**
```json
{
  "model": "BAAI/bge-m3",
  "data": [
    {
      "index": 0,
      "sparse": {
        "indices": [1284, 4592, 901],
        "values": [0.45, 0.21, 0.11],
        "mapping": "tokenizer",
        "index_space": 1048576
      }
    }
  ]
}
```

### 3. –ì–∏–±—Ä–∏–¥–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ (–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
`POST /v1/hybrid-embeddings`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏ dense, –∏ sparse –≤–µ–∫—Ç–æ—Ä—ã –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≤ Qdrant.

### 4. –†–µ—Ä–∞–Ω–∫–∏–Ω–≥ (Cohere Style)
`POST /v1/rerank`

–í—ã—á–∏—Å–ª—è–µ—Ç –æ—Ü–µ–Ω–∫—É —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–∞—Ä –∑–∞–ø—Ä–æ—Å-–¥–æ–∫—É–º–µ–Ω—Ç.

**Request:**
```json
{
  "query": "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–ø—É—Å–∫–∞",
  "documents": [
    "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥...",
    "–ö—É–ª–∏–Ω–∞—Ä–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –ø–∏—Ü—Ü—ã"
  ],
  "top_n": 1,
  "return_documents": false
}
```

**Response:**
```json
{
  "model": "BAAI/bge-reranker-v2-m3",
  "results": [
    {
      "index": 0,
      "relevance_score": 8.42,
      "document": null // –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω —Ç–µ–∫—Å—Ç–æ–º, –µ—Å–ª–∏ return_documents: true
    }
  ]
}
```

---

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RAG –ø–∞–π–ø–ª–∞–π–Ω–æ–º (–°—Ü–µ–Ω–∞—Ä–∏–∏)

–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ RAG-–ø–∞–π–ø–ª–∞–π–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞

```python
import os
import requests
from openai import OpenAI
from qdrant_client import QdrantClient

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
BGE_SERVICE_URL = os.getenv("BGE_SERVICE_URL", "http://localhost:8011")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# –ö–ª–∏–µ–Ω—Ç—ã
bge_session = requests.Session()
openai_client = OpenAI(api_key=OPENAI_API_KEY)
qdrant_client = QdrantClient(url="http://localhost:6333")

def get_bge_sparse(text: str) -> dict:
    """Helper –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è sparse –≤–µ–∫—Ç–æ—Ä–∞."""
    resp = bge_session.post(
        f"{BGE_SERVICE_URL}/v1/sparse-embeddings",
        json={"input": [text]}
    )
    resp.raise_for_status()
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É: {"indices": [...], "values": [...]}
    return resp.json()["data"][0]["sparse"]

def get_bge_hybrid(text: str) -> dict:
    """Helper –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è hybrid (dense+sparse)."""
    resp = bge_session.post(
        f"{BGE_SERVICE_URL}/v1/hybrid-embeddings",
        json={"input": [text]}
    )
    resp.raise_for_status()
    return resp.json()["data"][0]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π A: Ingest (OpenAI Dense + BGE Sparse)

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ Dense-–≤–µ–∫—Ç–æ—Ä–æ–≤ –æ—Ç OpenAI (1536 dim), –Ω–æ –¥–æ–±–∞–≤–∏—Ç—å keyword-search —á–µ—Ä–µ–∑ BGE-M3.

```python
def ingest_document_openai_bge(text: str, doc_id: str):
    # 1. –ü–æ–ª—É—á–∞–µ–º Dense –æ—Ç OpenAI
    dense_resp = openai_client.embeddings.create(
        input=text,
        model="text-embedding-3-small"
    )
    dense_vector = dense_resp.data[0].embedding

    # 2. –ü–æ–ª—É—á–∞–µ–º Sparse –æ—Ç BGE Service
    sparse_vector = get_bge_sparse(text)

    # 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Qdrant
    qdrant_client.upsert(
        collection_name="my_collection",
        points=[{
            "id": doc_id,
            "vector": {
                "dense": dense_vector,
                "sparse": sparse_vector
            },
            "payload": {"text": text}
        }]
    )
```

### –°—Ü–µ–Ω–∞—Ä–∏–π B: Ingest (Full Hybrid via BGE)

–ü–æ–ª–Ω–æ—Å—Ç—å—é –ª–æ–∫–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ OpenAI). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Dense (1024 dim) –∏ Sparse –æ—Ç BGE-M3.

```python
def ingest_document_full_bge(text: str, doc_id: str):
    # 1. –ü–æ–ª—É—á–∞–µ–º –æ–±–∞ –≤–µ–∫—Ç–æ—Ä–∞ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ GPU-—Å–µ—Ä–≤–∏—Å—É
    hybrid_result = get_bge_hybrid(text)
    
    dense_vector = hybrid_result["dense"]
    sparse_vector = hybrid_result["sparse"]

    # 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Qdrant
    qdrant_client.upsert(
        collection_name="my_collection",
        points=[{
            "id": doc_id,
            "vector": {
                "dense": dense_vector,
                "sparse": sparse_vector
            },
            "payload": {"text": text}
        }]
    )
```

### –°—Ü–µ–Ω–∞—Ä–∏–π C: Retrieval (Hybrid Search)

–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø–æ–∏—Å–∫ –≤ –ë–î —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Prefetch.

```python
def search_documents(query: str, top_k: int = 10):
    # 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–µ–∫—Ç–æ—Ä—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ (Full BGE –≤–∞—Ä–∏–∞–Ω—Ç)
    hybrid_query = get_bge_hybrid(query)
    dense_query = hybrid_query["dense"]
    sparse_query = hybrid_query["sparse"]

    # 2. –í—ã–ø–æ–ª–Ω—è–µ–º –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –≤ Qdrant
    search_result = qdrant_client.query_points(
        collection_name="my_collection",
        prefetch=[
            {
                "query": dense_query,
                "using": "dense",
                "limit": top_k
            },
            {
                "query": sparse_query,
                "using": "sparse",
                "limit": top_k
            }
        ],
        limit=top_k
    )
    
    return [hit.payload for hit in search_result.points]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π D: Rerank & LLM Context

–ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ LLM (Cross-Encoder).

```python
def generate_answer(query: str, initial_docs: list[dict]):
    # initial_docs - —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –ø–æ–ª–µ–º 'text' –∏–∑ —à–∞–≥–∞ Retrieval
    
    # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–µ—Ä–∞–Ω–∫–µ—Ä–∞
    docs_text = [doc["text"] for doc in initial_docs]

    # 2. –ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–∏—Å—É —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞ (/v1/rerank)
    rerank_resp = bge_session.post(
        f"{BGE_SERVICE_URL}/v1/rerank",
        json={
            "query": query,
            "documents": docs_text,
            "top_n": 5,           # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –¢–û–ü-5 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö
            "return_documents": False 
        }
    )
    rerank_resp.raise_for_status()
    results = rerank_resp.json()["results"]
    
    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞
    top_docs = [initial_docs[res["index"]]["text"] for res in results]
    context_str = "\n\n".join(top_docs)

    # 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ LLM
    completion = openai_client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": "–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞."},
            {"role": "user", "content": f"–ö–æ–Ω—Ç–µ–∫—Å—Ç:\n{context_str}\n\n–í–æ–ø—Ä–æ—Å: {query}"}
        ]
    )
    
    return completion.choices[0].message.content
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —é–∑–∫–µ–π—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç:

```bash
# –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π requests –∏ pytest
python bge_inference_service/test_integration.py
```

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è
–î–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é —Å–∏—Å—Ç–µ–º—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è "–∫–∞–∫ –µ—Å—Ç—å". –ú–æ–¥–µ–ª–∏ BGE –∏ Reranker –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç BAAI –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ–¥ –∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏.
